#!/bin/bash

if ! [ $# -eq 4 ]; then
    APP_NAME="$(basename $0)"
    echo "${APP_NAME}: usage is: ${APP_NAME} {QEMU_ARCH} {QEMU_CPU} {TIMEOUT} {SYS_SIZE}"
    echo -e "QEMU_ARCH:\tQEMU systemn target platform"
    echo -e "QEMU_CPU:\tQEMU system target CPU"
    echo -e "TIMEOUT:\tBuild time in minutes before machine is powered off"
    echo -e "SYS_SIZE:\tTotal system disks size in GBi"
    exit 1
fi

DT="$(date --utc --iso-8601=seconds)"
BOOTPATH=boot
QEMU_ARCH="$1"
QEMU_CPU="$2"
TIMEOUT="$((($3-5)*60))"
# ceiling of system image size if decimal
SYS_COUNT="$(echo $4|awk 'function ceil(v) { return v%1?int(v)+1:v } { a=ceil($1/1.5) } ; { print ceil(a) }')"

rm -rf "$BOOTPATH"
mkdir "$BOOTPATH"
cp -f fetch/linux "$BOOTPATH"
cp -f fetch/initrd.gz "$BOOTPATH"
# cp -f edk2-aarch64-code.fd.bz2 "$BOOTPATH"
# bzip2 -d "$BOOTPATH/edk2-aarch64-code.fd.bz2"

# add shutdown hook
cd "$BOOTPATH"
gzip -d initrd.gz
cpio -H newc -F initrd -idmv etc/inittab
echo '::shutdown:/onfail.sh' >>etc/inittab
echo etc/inittab|cpio -H newc -F initrd -oAv
gzip initrd
cd -

# set watchdog
sed "s/TIMEOUT/${TIMEOUT}/g" -i ./watchdog.sh
echo "WATCHDOG: timeout = $TIMEOUT"
# add preseed
ls ./preseed.cfg ./setmirror.sh ./watchdog.sh ./onfail.sh|cpio -H newc -R +0:+0 -o|gzip >>"$BOOTPATH/initrd.gz"

# create system image hd
for i in $(seq 1 "${SYS_COUNT}"); do rm -f "$BOOTPATH/sys_$i.img"; done
for i in $(seq 1 "${SYS_COUNT}"); do qemu-img create -f qcow2 "$BOOTPATH/sys_$i.img" 1.5G; done
ls -l "$BOOTPATH"

"qemu-system-${QEMU_ARCH}" \
    -d unimp,guest_errors \
    -D qemu.log \
    -serial mon:stdio \
    -machine virt,virtualization=true,kernel_irqchip=on,gic-version=3 \
    -cpu "${QEMU_CPU}" \
    -m 512M \
    -kernel "$BOOTPATH/linux" \
    -initrd "$BOOTPATH/initrd.gz" \
    -append "earlyprintk=serial console=ttyAMA0 BOOT_DEBUG=0 DEBIAN_FRONTEND=text debconf/priority=critical auto-install/enable=true" \
    -nographic \
    -netdev user,id=net0 \
    -device driver=virtio-net-pci,netdev=net0 \
    -object rng-random,filename=/dev/urandom,id=rng0 \
    -device virtio-rng-pci,rng=rng0 \
    -rtc base=utc,clock=host \
    -device virtio-scsi-pci,id=scsi0 \
    -device scsi-hd,drive=syshd,bus=scsi0.0,channel=0,scsi-id=0,lun=0 \
    -drive file="$BOOTPATH/sys_1.img",format=qcow2,if=none,id=syshd
#    -cdrom https://nl.alpinelinux.org/alpine/latest-stable/releases/aarch64/alpine-standard-3.13.5-aarch64.iso
#    -machine dumpdtb=virt.dtb \
#    -bios "edk2-aarch64-code.fd" \
#    -append "earlyprintk=serial console=ttyAMA0 init=/bin/ash" \
#    -append "earlyprintk=serial console=ttyAMA0 DEBIAN_FRONTEND=text debconf/priority=low" \

cd "$BOOTPATH"
md5sum linux initrd.gz sys_*.img >MD5SUMS
cd -

# if terminal then reset
if [ -t 0 -a -t 1 -a -t 2 ]
then
    reset
fi
